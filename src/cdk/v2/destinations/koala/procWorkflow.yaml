bindings:
  - name: EventType
    path: ../../../../constants
  - name: defaultRequestConfig
    path: ../../../../v0/util

steps:
  - name: validateInput
    template: |
      $.assert(.message.type, "message Type is not present. Aborting message");
      $.assert(.message.type in {{$.EventType.([.IDENTIFY, .TRACK])}}, 
        "message type " + .message.type + " is not supported");
      $.assertConfig(.destination.Config.publicKey, "publicKey is not present. Aborting message");
      $.assert(.message.traits.email, "email is not present on traits. Aborting message");
  - name: buildResponse
    description: In batchMode we return payload directly
    condition: $.batchMode
    template: .message
    else:
      name: buildResponseForProcessTransformation
      template: |
        const response = $.defaultRequestConfig();
        response.body.JSON = .message;
        response.endpoint = "https://api2.getkoala.com/web/profiles/"+ .destination.Config.publicKey + "/batch";
        response.headers = {
          "content-type": "application/json"
        };
        response
